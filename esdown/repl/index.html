<!DOCTYPE html>
<html>
<head>
<title>esdown :: repl</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>

#terminal {

    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 40%;
    padding: 4px;
    overflow: auto;
}

#terminal, #terminal textarea {

    font: 16px "Consolas", "Monaco", monospace;
    background-color: #000;
    color: #fff;
}

div.input-line, div.output-line {

    position: relative;
    top: 0;
    left: 0;
    margin: 2px;
}

div.output-line.echo {

    padding-left: 2.2em;
}

#terminal span.prompt {

    position: absolute;
    top: 0;
    left: 0;
}

div.output-line {

    white-space: pre-wrap;
}

#terminal span.prompt:first-child:before {

    content: ">>>";
}

#terminal span.prompt.cont:first-child:before {

    content: "...";
}

#terminal textarea {

    border: none;
    outline: none;
    width: 100%;
    margin: 0;
    padding: 0 0 0 2.2em;
    box-sizing: border-box;
    resize: none;
    overflow: hidden;
}

#terminal textarea.hidden {

    visibility: hidden;
    position: absolute;
    top: 0px;
    left: 0px;
}

#content {

    font: 16px Arial;
    background-color: #fff;
    color: #000;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 60%;
    right: 0;
    overflow: auto;
    padding: 20px;
}

#content :first-child {

    margin-top: 0;
}

#content :last-child {

    margin-bottom: 40px;
}

#content h1 {

    font-size: 2.6em;
}

#content a {

    text-decoration: none;
}

#content a:hover {

    text-decoration: underline;
}

#content table {

    width: 100%;
    border-spacing: 0;
    border-collapse: collapse;
    border: solid 1px #eee;
}

#content td {

    border-bottom: solid 1px #eee;
    padding: 5px 8px;
}

#content code {

    font: 14px "Consolas", "Monaco", monospace;
}


.js-special { color: cyan }
.js-number { color: yellow }
.js-boolean { color: yellow }
.js-undefined { color: grey }
.js-null { font-weight: bold }
.js-string { color: green }
.js-date { color: magenta }
.js-regexp { color: red }
.js-name {}
.js-ok { color: green }
.js-error { color: red }

@media (max-width: 850px) {

    #terminal {

        right: 0;
    }

    #content {

        display: none;
    }
}

</style>

<script src="pretty-print.js"></script>

<script src="esdown.js"></script>

<script>

    var REGENERATOR_URL = "https://facebook.github.io/regenerator/bundle.js";

    // Load regenerator if engine does not support generator functions
    try {

        window.eval("(function*() {})");

    } catch (x) {

        document.write("<script src='" + REGENERATOR_URL + "'><\/script>");
        document.write("<script>regenerator.runtime()<\/script>");
    }

</script>

<script>

// Adapted from underscore
var escapeHTML = (function() { "use strict";

    // List of HTML entities for escaping.
    var escapeMap = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#x27;',
        '`': '&#x60;'
    };

    // Functions for escaping and unescaping strings to/from HTML interpolation.
    function createEscaper(map) {

        function escaper(match) { return map[match] }

        // Regexes for identifying a key that needs to be escaped
        var source = '(?:' + Object.keys(map).join('|') + ')';
        var testRegexp = RegExp(source);
        var replaceRegexp = RegExp(source, 'g');

        return function(string) {
            string = string == null ? '' : '' + string;
            return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
        };
    }

    return createEscaper(escapeMap);

})();

function replEval() { return window.eval(arguments[0]) }

window.onload = function() { "use strict";

    var HELP_TEXT = [

        "",
        "[esdown v" + _esdown.version + "]",
        "",
        "This REPL will translate ES6+ syntax and execute the resulting " +
        "code in your current JavaScript engine.",
        "",
        "The following REPL commands are supported:",
        "",
        ".help                  Display this help message",
        ".clear                 Clear the terminal output",
        ".load                  Load a script from a URL",
        ".translate             Translate script code to ES5",
        ".translateModule       Translate module code to ES5",
        ".parse                 Parse script code",
        ".parseModule           Parse module code",
        "\n",

    ].join("\n");

    var SCRIPT_URLS = {

        "jquery": "https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js",
        "regenerator": REGENERATOR_URL,
    };

    var MAX_CONSOLE_LINES = 100,
        NO_OUTPUT = {},
        NEWLINE = /\r\n?|\n/g;

    function Literal(text) { this.text = text }

    var replCommands = {

        help: function() { return new Literal(HELP_TEXT) },
        clear: function() { return clearLines(1), NO_OUTPUT },
        load: function(url) { return loadScript(url), NO_OUTPUT },
        translate: function(code) { return new Literal(esdown.translate(code)) },
        translateModule: function(code) { return new Literal(esdown.translate(code, { module: true })) },
        parse: function(code) { return esdown.parse(code).ast },
        parseModule: function(code) { return esdown.parse(code, { module: true }).ast },
        link: function() { return new Literal(generateLink()) }
    };

    var history = {

        list: [""],
        max: 50,
        current: 0,

        add: function(str) {

            var len = this.list.length;

            this.list[len - 1] = str;
            this.list.push("");
            this.current = len;
        },

        back: function(str) {

            this._check(str);

            if (this.current > 0)
                this.current -= 1;

            return this.list[this.current];
        },

        forward: function(str) {

            this._check(str);

            if (this.current < this.list.length - 1)
                this.current += 1;

            return this.list[this.current];
        },

        _check: function(str) {

            if (str !== this.list[this.current]) {

                this.current = this.list.length - 1;
                this.list[this.current] = str;
            }
        }
    };

    function hasOwn(obj, key) {

        return Object.prototype.hasOwnProperty.call(obj, key);
    }

    function loadScript(name) {

        var url = hasOwn(SCRIPT_URLS, name) ? SCRIPT_URLS[name] : name;

        var s = document.createElement("script");
        s.async = true;
        s.src = url;
        elem("head").appendChild(s);

        s.onload = function() {

            addLine(stylize("Script loaded from " + url, "ok"));

            if (name === "regenerator")
                regenerator.runtime();
        };

        s.onerror = function() {

            addLine(stylize("Error: Unable to load script from " + url, "error"));
        };

        s = null;
    }

    function isOpaque(obj) {

        return obj instanceof Node;
    }

    function elem(s) {

        return document.querySelector(s);
    }

    function elems(s) {

        return document.querySelectorAll(s);
    }

    function stylize(str, styleType) {

        str = escapeHTML(str);
        if (styleType) str = '<span class="js-' + styleType + '">' + str + '</span>';
        return str;
    }

    function isRecoverableError(e, code) {

        if (/(\n[ \t]*){2}$/.test(code))
            return false;

        var pattern = /^(Unexpected end of input|Unexpected token )/;
        return e && e.name === 'SyntaxError' && pattern.test(e.message);
    }

    function formatError(error) {

        var message = "" + error,
            stack = message;

        if (error.stack) {

            stack = error.stack;

            var m = /(^|\s)replEval[:@\s]/.exec(stack);

            if (m) {

                var start = Math.max(stack.lastIndexOf("\n", m.index + 1), 0);
                stack = stack.slice(0, start);
            }

            if (stack.indexOf(message) < 0)
                stack = message + "\n" + stack;
        }

        return escapeHTML(stack).replace(/^.+/, function(m) {

            return "<span class='js-error'>" + m + "</span>";
        });
    }

    function replRun() {

        var code = input.value;

        if (bufferedInput)
            code = bufferedInput + "\n" + code;

        advanceInput(function() {

            var executed = false,
                output = "",
                result,
                error;

            if (code.charAt(0) === ".") {

                var cmd = code.slice(1).replace(/\s[\s\S]*/g, "");

                if (typeof replCommands[cmd] === "function") {

                    executed = true;
                    try { result = replCommands[cmd](code.slice(cmd.length + 1).trim()) }
                    catch (x) { error = x || {} }
                }
            }

            if (!executed) {

                executed = true;

                try {

                    code = esdown.translate(code);

                    if (code.indexOf("*") >= 0 && window.regenerator)
                        code = regenerator.compile(code).code;

                    result = replEval(code);

                } catch (x) {

                    error = x || {};
                }
            }

            if (isRecoverableError(error, code)) {

                bufferedInput = code;

            } else if (result !== NO_OUTPUT) {

                bufferedInput = "";

                output =
                    error ? formatError(error) :
                    result instanceof Literal ? escapeHTML(result.text) :
                    prettyPrint(result, { stylize: stylize, isOpaque: isOpaque });
            }

            return output;

        });
    }

    function autoIndent(last) {

        var indent = last.split(NEWLINE).pop().replace(/\S[\s\S]*/, "");

        if (/[\{\[]\s*$/.test(last))
            indent += "  ";

        return indent;
    }

    function advanceInput(fn) {

        var value = input.value;

        history.add(value);

        addLine(escapeHTML(value), prompt.className);
        setInputValue("");

        var output = fn && fn() || "";

        if (output)
            addLine(output);

        prompt.className = bufferedInput ? "prompt cont" : "prompt";

        clearLines(MAX_CONSOLE_LINES);

        if (bufferedInput)
            setInputValue(autoIndent(value));

        input.focus();
        input.scrollIntoView();
    }

    function clearLines(max) {

        var list = terminal.getElementsByTagName("div");

        for (var count = list.length; count-- > max;)
            terminal.removeChild(list[0]);
    }

    function addLine(html, promptClass) {

        var line = document.createElement("div");
        line.className = "output-line";
        line.innerHTML = html || " ";

        if (promptClass) {

            var span = document.createElement("span");
            span.className = promptClass;
            line.insertBefore(span, line.firstChild);
            line.className += " echo";
        }

        terminal.insertBefore(line, input.parentNode);
    }

    function abort() {

        bufferedInput = "";
        advanceInput();
    }

    var resizeTimer = 0;

    function resizeInput() {

        if (resizeTimer)
            return;

        resizeTimer = setTimeout(function() {

            resizeTimer = 0;

            var value = input.value;

            if (value === "") {

                input.style.height = "auto";

            } else {

                hidden.style.width = input.scrollWidth;
                hidden.value = value;
                input.style.height = (hidden.scrollHeight + hidden.clientHeight) + "px";
            }

        }, 50);
    }

    function onKeyPress(evt) {

        // Enter
        if (evt.keyCode === 13) {

            if (!evt.shiftKey && !evt.ctrlKey) {

                replRun();
                evt.preventDefault();
                return;
            }
        }

        resizeInput();
    }

    function setInputValue(value) {

        input.value = value;
        input.selectionStart = value.length;
        input.selectionEnd = value.length;
        prompt.scrollIntoView();
        resizeInput();
    }

    function isCursorRow(row) {

        var val = input.value;

        if (!val)
            return true;

        var start = input.selectionStart;

        if (start !== input.selectionEnd)
            return false;

        if (row === "first") {

            var index = val.search(NEWLINE);
            return index < 0 || index >= start;

        } else if (row === "last") {

            return start >= val.length - val.split(NEWLINE).pop().length;

        } else {

            return false;
        }
    }

    function onKeyDown(evt) {

        // CTL-C, ESC
        if (evt.ctrlKey && evt.keyCode === 67 || evt.keyCode === 27) {

            abort();
            evt.preventDefault();
            return;
        }

        // Up arrow
        if (evt.keyCode === 38 && isCursorRow("first")) {

            setInputValue(history.back(input.value));
            evt.preventDefault();
            return;
        }

        // Down arrow
        if (evt.keyCode === 40 && isCursorRow("last")) {

            setInputValue(history.forward(input.value));
            evt.preventDefault();
            return;
        }
    }

    function onClick() {

        if (!window.getSelection || window.getSelection().isCollapsed)
            input.focus();
    }

    function onPaste() {

        resizeInput();
    }

    function createHidden() {

        var e = document.createElement(input.nodeName);
        e.className = "hidden";
        e.rows = 1;
        input.parentNode.appendChild(e);
        return e;
    }

    function loadFromHash() {

        var m = /____(.+)/.exec(window.location.hash);

        if (m) {

            input.value = decodeURIComponent(m[1]);
            resizeInput();
        }
    }

    function generateLink() {

        var out = [].map.call(elems("div.echo"), function(e) {

            return e.innerText.trim();

        }).filter(function(text) {

            return text.charAt(0) !== ".";

        }).join("\n");

        out = "____" + encodeURIComponent(out);

        window.location.hash = out;

        return window.location.toString().replace(/#[\s\S]*/, "") + "#" + out;
    }

    var terminal = elem("#terminal"),
        input = elem("#terminal-input"),
        hidden = createHidden(),
        prompt = elem("#terminal div.input-line span"),
        bufferedInput = "";

    terminal.addEventListener("click", onClick, false);
    input.addEventListener("keypress", onKeyPress, false);
    input.addEventListener("keydown", onKeyDown, false);
    input.addEventListener("paste", onPaste, false);

    input.focus();

    window.contentElement = elem("#content");
    window.print = function(str) { addLine(str + "") };

    if (window.console) {

        var consoleLog = window.console.log;

        window.console.log = function(arg) {

            window.print(arg);
            consoleLog.apply(this, arguments);
        };
    }

    window.onerror = function(error) {

        addLine(formatError(error));
    };

    loadFromHash();

};

</script>

</head>
<body>

<div id="terminal">
    <div class="input-line">
        <span class="prompt"></span>
        <textarea id="terminal-input" spellcheck="false" rows="2"></textarea>
    </div>
</div>

<div id="content">
    <h1>esdown :: repl</h1>
    <p>
        This is a REPL (Read-Eval-Print-Loop) which compiles ES6+ code and executes it
        in your browser.
    </p>
    <p>
        Code is compiled from ES6+ to ES5 using the <a href="https://github.com/zenparsing/esdown" target="_blank"><strong>esdown</strong></a>
        javascript library.
    </p>
    <p>
        Generator functions are compiled with <a href="https://github.com/facebook/regenerator" target="_blank"><strong>regenerator</strong></a>
        if your browser doesn't support them natively.
    </p>

    <h2>Global Variables</h2>

    <p>The following global variables are defined for convenience:</p>

    <table>
    <tr>
        <td><code>contentElement</code></td>
        <td>The <strong>div</strong> element which contains the content you're reading.
            You can use this element to modify the DOM.
        </td>
    </tr>
    <tr>
        <td><code>print(text)</code></td>
        <td>Prints a string to the REPL output.</td>
    </tr>
    </table>

    <h2>REPL Commands</h2>

    <p>The following REPL commands are supported:</p>

    <table>
    <tr>
        <td><code>.help</code></td>
        <td>Displays the REPL help.</td>
    </tr>
    <tr>
        <td><code>.clear</code></td>
        <td>Clears the terminal output.</td>
    </tr>
    <tr>
        <td><code>.load</code></td>
        <td>Loads a script from a URL.</td>
    </tr>
    <tr>
        <td><code>.translate</code></td>
        <td>Translates script code to ES5.</td>
    </tr>
    <tr>
        <td><code>.translateModule</code></td>
        <td>Translates module code to ES5.</td>
    </tr>
    <tr>
        <td><code>.parse</code></td>
        <td>Parses script code and displays an AST.</td>
    </tr>
    <tr>
        <td><code>.parseModule</code></td>
        <td>Parses module code and displays an AST.</td>
    </tr>
    </table>

</div>

</body>
</html>
